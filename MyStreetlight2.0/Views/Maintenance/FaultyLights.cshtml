@using MyStreetlight2._0.DTOs.MaintenanceDtos
@using MyStreetlight2._0.ViewModels
@using MyStreetlight2._0.Utilities
@model FaultyLightListViewModel

@{
	ViewData["Title"] = "Maintenance Dashboard";
}

<style>
	.scroll-container {
		scrollbar-width: thin;
		scrollbar-color: transparent transparent;
	}

	.scroll-container::-webkit-scrollbar {
		width: 1px; /* thinner vertical scrollbar */
		height: 1px; /* thinner horizontal scrollbar */
	}

	.scroll-container::-webkit-scrollbar-track {
		background: #f1f5f9;
		border-radius: 3px;
	}

	.scroll-container::-webkit-scrollbar-thumb {
		background-color: transparent;
		border-radius: 1px;
	}

	#lightsMap {
		border-radius: 0.75rem;
		box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
		transition: all 0.3s ease;
	}

	#lightsMap:hover {
		box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
	}

	.map-controls {
		background: rgba(255, 255, 255, 0.95);
		backdrop-filter: blur(10px);
		border-radius: 0.5rem;
		box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
		padding: 0.75rem;
	}

	.status-filter {
		display: flex;
		justify-content: space-evenly;
		flex-wrap: wrap;
	}

	.filter-btn {
		padding: 0.5rem 1rem;
		border-radius: 2rem;
		font-size: 0.875rem;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s ease;
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.filter-btn.active {
		color: white;
	}

	.filter-btn:not(.active) {
		background: #f1f5f9;
		color: #64748b;
	}

	.filter-btn:not(.active):hover {
		background: #e2e8f0;
	}

	.filter-faulty.active {
		background: #dc2626;
	}

	.filter-inprocess.active {
		background: #d97706;
	}

	.filter-repaired.active {
		background: #059669;
	}

	.stats-card {
		background: rgba(255, 255, 255, 0.9);
		backdrop-filter: blur(10px);
		border-radius: 0.5rem;
		padding: 0.75rem 1rem;
		box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
	}

	.legend-item {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		margin-bottom: 0.5rem;
	}

	.legend-color {
		width: 16px;
		height: 16px;
		border-radius: 50%;
		border: 2px solid white;
		box-shadow: 0 1px 3px rgba(0,0,0,0.2);
	}

	.custom-popup {
		min-width: 240px;
	}

	.popup-header {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		padding-bottom: 0.5rem;
		border-bottom: 1px solid #e5e7eb;
		margin-bottom: 0.75rem;
	}

	.popup-status {
		padding: 0.25rem 0.5rem;
		border-radius: 1rem;
		font-size: 0.75rem;
		font-weight: 600;
	}

	.status-faulty {
		background: #fecaca;
		color: #dc2626;
	}

	.status-inprocess {
		background: #fed7aa;
		color: #d97706;
	}

	.status-repaired {
		background: #a7f3d0;
		color: #059669;
	}

	.popup-actions {
		display: flex;
		gap: 0.5rem;
		margin-top: 0.75rem;
	}

	.action-btn {
		flex: 1;
		padding: 0.5rem;
		border-radius: 0.375rem;
		font-size: 0.875rem;
		font-weight: 500;
		text-align: center;
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.action-view {
		background: #dbeafe;
		color: #2563eb;
	}

	.action-view:hover {
		background: #bfdbfe;
	}

	.action-assign {
		background: #fef3c7;
		color: #d97706;
	}

	.action-assign:hover {
		background: #fde68a;
	}

	.leaflet-popup-content-wrapper {
		border-radius: 0.75rem;
		box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
	}

	.filter-btn {
		padding: 0.375rem 0.75rem;
		font-size: 0.8rem;
	}

	.stats-card {
		padding: 0.5rem 0.75rem;
	}
</style>

<script>
	// Data from server
	const faultyLights = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.FaultyLights));
	const inProcessLights = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.InProcessLights));
	const repairedLights = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RepairedLights));
</script>

@* Import feedback partial here *@
@await Html.PartialAsync("_Feedback")

@* Import faulty light maintenance log partial here *@
@* @await Html.PartialAsync("_LightMaintenanceLogsPartial", Model.FaultyLightMaintenanceLogData); *@

<div class="px-2 sm:px-6">
	<div class="mx-auto max-w-7xl">
		<!-- Header -->
		<div class="glass-card mb-1.5 rounded-xl border-[#abb3c2] px-4 py-4 shadow-sm">
			<div class="flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
				<!-- Logo + Title -->
				<div class="flex items-center space-x-4">
					<div class="from-primary-500 to-primary-700 mr-3 flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-br text-white shadow-lg">
						<i class="fas fa-lightbulb text-xl"></i>
					</div>
					<div>
						<h1 class="text-lg font-semibold sm:text-2xl sm:font-bold">Maintenance Team Dashboard</h1>
						<p class="text-xs text-gray-500 sm:text-sm">Monitor and Manage Faulty Lights</p>
					</div>
				</div>

				<!-- Stats Section -->
				<div class="grid grid-cols-3 gap-2 text-center">
					<div class="flex flex-col items-center justify-between rounded-lg border border-gray-200 px-4 py-2.5 shadow-sm sm:flex-row">
						<span class="text-sm font-medium">Faulty</span>
						<span class="font-bold text-red-500" id="faultyCount">@Model.FaultyLights.Count()</span>
					</div>
					<div class="flex flex-col items-center justify-between rounded-lg border border-gray-200 px-4 py-2.5 shadow-sm sm:flex-row">
						<span class="text-sm font-medium sm:mr-2">In Process</span>
						<span class="font-bold text-amber-500" id="inprocessCount">@Model.InProcessLights.Count()</span>
					</div>
					<div class="flex flex-col items-center justify-between rounded-lg border border-gray-200 px-4 py-2.5 shadow-sm sm:flex-row">
						<span class="text-sm font-medium">Repaired</span>
						<span class="font-bold text-green-500" id="repairedCount">@Model.RepairedLights.Count()</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Two Column Layout -->
		<div class="grid grid-cols-1 gap-1.5 md:grid-cols-2 lg:grid-cols-3">
			<!-- Left Column - Faulty Lights -->
			<div class="glass-card rounded-xl border-red-500 border-t-[3px] bg-white p-4 dark:border-red-500 dark:border-t-[3px]">
				<div class="mb-4 flex items-center justify-between">
					<h2 class="flex items-center text-lg font-semibold">
						<i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
						Faulty Lights
						<span class="ml-2 rounded-full bg-red-100 px-2 py-1 text-xs text-red-800">@Model.FaultyLights.Count()</span>
					</h2>
				</div>

				<!-- Faulty Lights List -->
				<div class="scroll-container max-h-[450px] min-h-[450px] overflow-y-auto">
					<div class="space-y-1.5">
						@if (Model?.FaultyLights != null && Model.FaultyLights.Any())
						{
							foreach (var light in Model.FaultyLights)
							{
								<!-- New Fault Item -->
								<div class="blink-new rounded-lg border border-red-500 border-l-[3px] p-[0.70rem] py-2" data-status="new" data-id="@light.LightId">
									<div class="flex items-start justify-between">
										<div class="min-w-0 flex-1">
											<div class="flex items-center justify-between">
												<div class="flex items-center">
													<span class="mr-2 h-2 w-2 rounded-full bg-red-500"></span>
													<span onclick="viewMaintenanceLogs(@light.FaultId)" class="fault-id cursor-pointer">@light.LightId</span>
													<span class="status-badge ml-2 inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800">
														New
													</span>
												</div>
												<div class="ml-2 flex-shrink-0">
													<a asp-action="MarkAsAcknowledged" asp-controller="Maintenance" asp-route-faultId="@light.FaultId" class="rounded-[0.375rem] bg-blue-100 px-[0.7rem] py-[0.35rem] font-semibold text-[0.8rem] text-blue-700 hover:bg-blue-200">
														Acknowledged
													</a>
												</div>
											</div>
											<div class="mt-1 flex items-center justify-between">
												<div class="truncate text-[0.8rem]">
													<i class="fas fa-map-marker-alt mr-0.5 text-rose-500"></i>
													<a class="text-blue-600 hover:text-blue-800 hover:underline"
													   href="https://www.google.com/maps?q=@light.Latitude,@light.Longitude"
													   target="_blank">
														@light.Address
													</a>
												</div>
												<div class="group relative ml-3 cursor-pointer text-[0.75rem]">
													<span class="block group-hover:hidden">@Helper.ToTimeAgo(light.FaultAt)</span>
													<span class="hidden group-hover:block">@light.FaultAt.ToString("dd MMM yyyy hh:mm")</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							}
						}
						else
						{
							<div class="flex items-center justify-center">
								<p class="p-3 text-center text-gray-500">No faulty lights found.</p>
							</div>
						}
					</div>
				</div>
			</div>

			<!-- In Process Content -->
			<div class="glass-card rounded-xl border-amber-500 border-t-[3px] bg-white p-4 dark:border-amber-500 dark:border-t-[3px]" id="inprogress-content">
				<div class="mb-4 flex items-center justify-between">
					<h2 class="flex items-center text-lg font-semibold">
						<i class="fas fa-tools mr-2 text-amber-500"></i>
						In Process
						<span class="ml-2 rounded-full bg-amber-100 px-2 py-1 text-xs text-amber-800">@Model.InProcessLights.Count()</span>
					</h2>
				</div>
				<div class="scroll-container max-h-[450px] min-h-[450px] overflow-y-auto">
					<div class="space-y-1.5">
						@if (Model?.InProcessLights != null && Model.InProcessLights.Any())
						{
							foreach (var light in Model.InProcessLights)
							{
								<!-- New Fault Item -->
								<div class="blink-new rounded-lg border border-amber-500 border-l-[3px] p-[0.70rem] py-2" data-status="new" data-id="@light.LightId">
									<div class="flex items-start justify-between">
										<div class="min-w-0 flex-1">
											<div class="flex items-center justify-between">
												<div class="flex items-center">
													<span class="mr-2 h-2 w-2 rounded-full bg-amber-500"></span>
													<span onclick="viewMaintenanceLogs(@light.FaultId)" class="fault-id cursor-pointer">@light.LightId</span>
													@if (light.Status == 1)
													{
														<span class="status-badge ml-2 inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800">Acknowledged</span>
													}
													else if (light.Status == 2)
													{
														<span class="status-badge ml-2 inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800">In Process</span>
													}
												</div>
												@if (light.Status == 1)
												{
													<div class="ml-2 flex-shrink-0">
														<a asp-action="MarkAsAssigned" asp-controller="Maintenance" asp-route-faultId="@light.FaultId" class="rounded-[0.375rem] bg-amber-100 px-[0.7rem] py-[0.35rem] font-semibold text-[0.8rem] text-amber-700 hover:bg-amber-200">
															Assign
														</a>
													</div>
												}
												else if (light.Status == 2)
												{
													<div class="ml-2 flex-shrink-0">
														<a asp-action="MarkAsRepaired" asp-controller="Maintenance" asp-route-faultId="@light.FaultId" class="rounded-[0.375rem] bg-green-100 px-[0.7rem] py-[0.35rem] font-semibold text-[0.8rem] text-green-700 hover:bg-green-200">
															Repaired
														</a>
													</div>
												}
											</div>
											<div class="mt-1 flex items-center justify-between">
												<div class="truncate text-[0.8rem]">
													<i class="fas fa-map-marker-alt mr-0.5 text-rose-500"></i>
													<a class="text-blue-600 hover:text-blue-800 hover:underline"
													   href="https://www.google.com/maps?q=@light.Latitude,@light.Longitude"
													   target="_blank">
														@light.Address
													</a>
												</div>
												<div class="group relative ml-3 cursor-pointer text-[0.75rem]">
													<span class="block group-hover:hidden">@Helper.ToTimeAgo(light.FaultAt)</span>
													<span class="hidden group-hover:block">@light.FaultAt.ToString("dd MMM yyyy hh:mm")</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							}
						}
						else
						{
							<div class="flex items-center justify-center">
								<p class="p-3 text-center text-gray-500">No In Processed lights found.</p>
							</div>
						}
					</div>
				</div>
			</div>

			<!-- Repaired Content -->
			<div class="tab-content glass-card rounded-xl border-green-500 border-t-[3px] bg-white p-4 dark:border-green-500 dark:border-t-[3px]">
				<div class="mb-4 flex items-center justify-between">
					<h2 class="flex items-center text-lg font-semibold">
						<i class="fas fa-check-circle mr-2 text-green-500"></i>
						Repaired
						<span class="ml-2 rounded-full bg-green-100 px-2 py-1 text-xs text-green-800">@Model.RepairedLights.Count()</span>
					</h2>
				</div>
				<div class="scroll-container max-h-[440px] min-h-[450px] overflow-y-auto">
					<div class="space-y-1.5">
						<!-- Repaired Item -->
						@if (Model?.RepairedLights != null && Model.RepairedLights.Any())
						{
							foreach (var light in Model.RepairedLights)
							{
								<!-- New Fault Item -->
								<div class="blink-new rounded-lg border border-green-500 border-l-[3px] p-[0.70rem] py-2" data-status="new" data-id="@light.LightId">
									<div class="flex items-start justify-between">
										<div class="min-w-0 flex-1">
											<div class="flex items-center justify-between">
												<div class="flex items-center">
													<span class="mr-2 h-2 w-2 rounded-full bg-green-500"></span>
													<span onclick="viewMaintenanceLogs(@light.FaultId)" class="fault-id cursor-pointer">@light.LightId</span>
													<span class="status-badge ml-2 inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">
														Repaired
													</span>
												</div>
												<div class="ml-2 flex-shrink-0">
													<a href="javascript:void(0);" onclick="viewMaintenanceLogs(@light.FaultId)" class="rounded-[0.375rem] bg-gray-100 px-[0.7rem] py-[0.35rem] font-semibold text-gray-700 text-[0.8rem] hover:bg-gray-200">
														View
													</a>
												</div>
											</div>
											<div class="mt-1 flex items-center justify-between">
												<div class="truncate text-[0.8rem]">
													<i class="fas fa-map-marker-alt mr-0.5 text-rose-500"></i>
													<a class="text-blue-600 hover:text-blue-800 hover:underline"
													   href="https://www.google.com/maps?q=@light.Latitude,@light.Longitude"
													   target="_blank">
														@light.Address
													</a>
												</div>
												<div class="group relative ml-3 cursor-pointer text-[0.75rem]">
													<span class="block group-hover:hidden">@Helper.ToTimeAgo(light.FaultAt)</span>
													<span class="hidden group-hover:block">@light.FaultAt.ToString("dd MMM yyyy hh:mm")</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							}
						}
						else
						{
							<div class="flex items-center justify-center">
								<p class="p-3 text-center text-gray-500">No Repaired lights found.</p>
							</div>
						}
					</div>
				</div>
			</div>
		</div>

		<!-- Map Container -->
		<div class="relative mt-2 hidden rounded-xl border border-[#abb3c2] dark:border-[rgba(255,255,255,0.125)]">
			<!-- Map Controls -->
			<div class="glass-card absolute right-1 bottom-4 z-[1000] w-full max-w-xs rounded-md bg-white/95 p-3 shadow-md backdrop-blur-md">
				<div class="relative mb-2">
					<input type="text" placeholder="Search lights..." id="searchLights" autocomplete="off"
						   class="w-full rounded-lg border border-[#abb3c2] px-4 py-2 pl-10 text-sm text-gray-800 focus:ring-1 focus:ring-blue-500 focus:outline-none dark:bg-gray-700/50 dark:text-gray-200">
					<i class="fas fa-search absolute top-2.5 left-3 text-gray-500 dark:text-gray-400"></i>
				</div>

				<div class="status-filter">
					<div class="filter-btn filter-faulty active" data-status="faulty">
						<i class="fas fa-exclamation-circle"></i>
						<span>Faulty</span>
					</div>
					<div class="filter-btn filter-inprocess active" data-status="inprocess">
						<i class="fas fa-tools"></i>
						<span>In Process</span>
					</div>
					<div class="filter-btn filter-repaired active" data-status="repaired">
						<i class="fas fa-check-circle"></i> 
						<span>Repaired</span>
					</div>
				</div>
			</div>

			<!-- Map Legend -->
			<div class="glass-card absolute top-4 right-4 z-[1000] hidden rounded-md bg-white/95 p-3 shadow-md backdrop-blur-md">
				<div class="mb-2 font-medium">Legend</div>
				<div class="legend-item">
					<div class="legend-color" style="background-color: #dc2626;"></div>
					<span class="text-sm">Faulty</span>
				</div>
				<div class="legend-item">
					<div class="legend-color" style="background-color: #d97706;"></div>
					<span class="text-sm">In Process</span>
				</div>
				<div class="legend-item">
					<div class="legend-color" style="background-color: #059669;"></div>
					<span class="text-sm">Repaired</span>
				</div>
			</div>

			<!-- Map -->
			<div id="lightsMap" class="h-[500px] w-full rounded-lg"></div>
		</div>
	</div>

	<!-- Popup Modal -->
	<div id="popupModal"
		 class="fixed inset-0 z-50 flex hidden items-center justify-center bg-black/50 backdrop-blur-sm">

		<!-- Popup Content -->
		<div class="animate-fadeIn relative max-h-[80vh] w-[600px] overflow-y-auto rounded-2xl bg-white shadow-2xl">
			<button onclick="closePopup()"
					class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
				✕
			</button>

			<!-- partial view content will load here -->
			<div id="maintenanceLogsContainer"></div>
		</div>
	</div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script src="~/js/Misc/attachtooltip.js?v=@DateTime.Now.Ticks"></script>
<script src="~/js/pages/faultylights.js?v=@DateTime.Now.Ticks"></script>

@* <div id="@($"{light.FaultId}_{light.FaultAt.Ticks}")"
	onmouseover="attachTooltip(this, '@light.FaultAt.ToString("dd MMM yyyy hh:mm")')"
	class="relative ml-3 text-[0.75rem]">
	@Helper.ToTimeAgo(light.FaultAt)
</div> *@
